{% extends "base.html" %}

{% block title %}Create Quote{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4" style="color: var(--edu-blue);">
        <i class="bi bi-file-earmark-text"></i> Create Quote
    </h2>
    
    <form method="POST" id="quoteForm">
        <!-- Section A: Customer Details -->
        <div class="card mb-4">
            <div class="card-header" style="background-color: var(--edu-blue); color: white;">
                <h5><i class="bi bi-person"></i> Customer Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Reference Number <span class="text-danger">*</span></label>
                        <input type="text" name="ref_number" class="form-control" 
                               placeholder="QTN/EDP/2025-26/0155" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Date <span class="text-danger">*</span></label>
                        <input type="date" name="date" class="form-control" 
                               value="{{ date.today().strftime('%Y-%m-%d') }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                        <input type="text" name="customer_name" class="form-control" 
                               placeholder="Dr. Vanila Sharma" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Designation</label>
                        <input type="text" name="designation" class="form-control" 
                               placeholder="Head, R & D">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Organization Name <span class="text-danger">*</span></label>
                        <input type="text" name="organization" class="form-control" 
                               placeholder="Tropical Animal Genetics" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="2" 
                                  placeholder="Full address"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section B: Product Search -->
        <div class="card mb-4">
            <div class="card-header" style="background-color: var(--edu-blue); color: white;">
                <h5><i class="bi bi-search"></i> Product Search</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" id="productSearch" class="form-control form-control-lg" 
                           placeholder="Search by Item Name, CAS No, Cat No, or Brand...">
                    <button class="btn btn-success" type="button" id="searchBtn">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
                <div id="searchResults" class="mt-3" style="display: none;">
                    <h6>Search Results:</h6>
                    <div id="resultsList" class="list-group"></div>
                </div>
            </div>
        </div>
        
        <!-- Section C: Quote Table -->
        <div class="card mb-4">
            <div class="card-header" style="background-color: var(--edu-blue); color: white;">
                <h5><i class="bi bi-table"></i> Quote Items</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="quoteTable">
                        <thead style="background-color: #f8f9fa;">
                            <tr>
                                <th>S.No</th>
                                <th>Item Name</th>
                                <th>Unit</th>
                                <th>Qty</th>
                                <th>Make/Brand</th>
                                <th>Catalog No</th>
                                <th>Rate/Price</th>
                                <th>Discount</th>
                                <th>Amount</th>
                                <th>GST %</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="quoteTableBody">
                            <tr id="emptyRow">
                                <td colspan="12" class="text-center text-muted">
                                    No items added. Search and add products above.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <input type="hidden" name="products_json" id="productsJson" value="[]">
            </div>
        </div>
        
        <!-- Print Button -->
        <div class="text-center mb-4">
            <button type="submit" class="btn btn-success btn-lg" style="min-width: 200px;">
                <i class="bi bi-printer"></i> Print Quote
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let products = [];
let serialNumber = 1;

// Search functionality
document.getElementById('searchBtn').addEventListener('click', searchProducts);
document.getElementById('productSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchProducts();
    }
});

function searchProducts() {
    const query = document.getElementById('productSearch').value.trim();
    if (!query) {
        alert('Please enter a search term');
        return;
    }
    
    fetch(`{{ url_for('quote.search_products') }}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data.products);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error searching products');
        });
}

function displaySearchResults(productsList) {
    const resultsDiv = document.getElementById('searchResults');
    const resultsList = document.getElementById('resultsList');
    
    if (productsList.length === 0) {
        resultsList.innerHTML = '<div class="alert alert-info">No products found</div>';
        resultsDiv.style.display = 'block';
        return;
    }
    
    resultsList.innerHTML = '';
    productsList.forEach(product => {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${product.item_name}</strong><br>
                    <small class="text-muted">
                        Brand: ${product.make_brand} | 
                        Cat No: ${product.cat_no || 'N/A'} | 
                        Rate: ₹${product.rate.toFixed(2)}
                    </small>
                </div>
                <button class="btn btn-success btn-sm" onclick="addProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
        `;
        resultsList.appendChild(item);
    });
    
    resultsDiv.style.display = 'block';
}

function addProduct(product) {
    // Add to products array
    const productItem = {
        id: product.id,
        item_name: product.item_name,
        unit: product.unit || 'Unit',
        qty: 1,
        make_brand: product.make_brand,
        cat_no: product.cat_no || '',
        rate: product.rate,
        discount: 0,
        amount: product.rate,
        gst_percent: product.gst_percent || 0.18,
        total: product.rate * (1 + (product.gst_percent || 0.18))
    };
    
    products.push(productItem);
    updateTable();
    
    // Clear search
    document.getElementById('productSearch').value = '';
    document.getElementById('searchResults').style.display = 'none';
}

function updateTable() {
    const tbody = document.getElementById('quoteTableBody');
    tbody.innerHTML = '';
    
    if (products.length === 0) {
        tbody.innerHTML = '<tr id="emptyRow"><td colspan="12" class="text-center text-muted">No items added. Search and add products above.</td></tr>';
        document.getElementById('productsJson').value = '[]';
        return;
    }
    
    products.forEach((product, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${product.item_name}</td>
            <td>
                <input type="text" class="form-control form-control-sm" value="${product.unit}" 
                       onchange="updateProduct(${index}, 'unit', this.value)">
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" value="${product.qty}" min="1" 
                       onchange="updateProduct(${index}, 'qty', parseFloat(this.value))">
            </td>
            <td>${product.make_brand}</td>
            <td>${product.cat_no}</td>
            <td>₹${product.rate.toFixed(2)}</td>
            <td>
                <input type="number" class="form-control form-control-sm" value="${product.discount}" step="0.01" min="0" 
                       onchange="updateProduct(${index}, 'discount', parseFloat(this.value))">
            </td>
            <td>₹<span id="amount_${index}">${product.amount.toFixed(2)}</span></td>
            <td>
                <input type="number" class="form-control form-control-sm" value="${(product.gst_percent * 100).toFixed(2)}" step="0.01" min="0" 
                       onchange="updateProduct(${index}, 'gst_percent', parseFloat(this.value) / 100)">
            </td>
            <td>₹<span id="total_${index}">${product.total.toFixed(2)}</span></td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="removeProduct(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update hidden JSON field
    document.getElementById('productsJson').value = JSON.stringify(products);
}

function updateProduct(index, field, value) {
    if (field === 'qty' || field === 'discount' || field === 'gst_percent') {
        products[index][field] = value;
    } else {
        products[index][field] = value;
    }
    
    // Recalculate amount and total
    const product = products[index];
    const subtotal = product.rate * product.qty;
    const discountAmount = subtotal * product.discount;
    product.amount = subtotal - discountAmount;
    product.total = product.amount * (1 + product.gst_percent);
    
    // Update display
    document.getElementById(`amount_${index}`).textContent = product.amount.toFixed(2);
    document.getElementById(`total_${index}`).textContent = product.total.toFixed(2);
    
    // Update JSON
    document.getElementById('productsJson').value = JSON.stringify(products);
}

function removeProduct(index) {
    products.splice(index, 1);
    updateTable();
}

// Form submission
document.getElementById('quoteForm').addEventListener('submit', function(e) {
    if (products.length === 0) {
        e.preventDefault();
        alert('Please add at least one product to the quote.');
        return false;
    }
});
</script>
{% endblock %}
